---
import { SEO } from 'astro-seo'
import Footer from '@components/footer.astro'
import Navbar from '@components/navbar/navbar.astro'
import { getLocale } from 'astro-i18n-aut'

export interface Props {
  title?: string
  description?: string
  image?: string
  noindex?: boolean
  type?: 'website' | 'article'
  schema?: Record<string, unknown> | Record<string, unknown>[]
}

const locale = getLocale(Astro.url)
const siteName = 'Švehla a Blaško'
const siteURL = Astro.site ?? new URL(Astro.url.origin)
const ogLocale = locale === 'sk' ? 'sk_SK' : 'en_US'
const localeAlternate = locale === 'sk' ? ['en_US'] : ['sk_SK']
const basePath = import.meta.env.BASE_URL.replace(/\/$/, '')
const defaultLocale = 'sk'
const routePath = Astro.url.pathname.startsWith(basePath)
  ? Astro.url.pathname.slice(basePath.length) || '/'
  : Astro.url.pathname
const cleanRoutePath = routePath
  .replace(/\/index\.html$/, '/')
  .replace(/\.html$/, '')
  .replace(/\/+$/, '') || '/'
const normalizedRoutePath = cleanRoutePath.replace(/^\/(en|sk)(?=\/|$)/, '') || '/'
const localizedPath = (lang: string) =>
  lang === defaultLocale
    ? `${basePath}${normalizedRoutePath === '/' ? '' : normalizedRoutePath}`
    : `${basePath}/${lang}${normalizedRoutePath === '/' ? '' : normalizedRoutePath}`
const canonicalURL = new URL(localizedPath(locale), siteURL).toString()
const languageAlternates = ['sk', 'en'].map((lang) => ({
  href: new URL(localizedPath(lang), siteURL).toString(),
  hrefLang: lang,
}))
const withBasePath = (path: string) => {
  if (/^https?:\/\//i.test(path)) return path
  const normalizedPath = path.startsWith('/') ? path : `/${path}`
  if (basePath && (normalizedPath === basePath || normalizedPath.startsWith(`${basePath}/`))) {
    return normalizedPath
  }
  return `${basePath}${normalizedPath}`
}

const defaultDescription =
  locale === 'en'
    ? 'Family-run CNC milling and turning in Slovakia. Prototype and small-batch machining with reliable tolerances, clear communication, and on-time delivery.'
    : 'Rodinná firma pre CNC frézovanie a sústruženie na Slovensku. Prototypy a menšie série so spoľahlivými toleranciami, priamou komunikáciou a dodaním načas.'

const {
  title = '',
  description = defaultDescription,
  image = '/opengraph.jpg',
  noindex = false,
  type = 'website',
  schema,
} = Astro.props

const resolvedImageWithDomain = new URL(withBasePath(image), siteURL).toString()
const makeTitle = title
  ? `${title} | ${siteName}`
  : locale === 'en'
    ? `${siteName} - Metalworking`
    : `${siteName} - Kovoobrábanie`

const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'Švehla a Blaško s. r. o.',
  url: new URL(basePath || '/', siteURL).toString(),
  logo: new URL(withBasePath('/favicon.svg'), siteURL).toString(),
}
const structuredData = [
  organizationSchema,
  ...(Array.isArray(schema) ? schema : schema ? [schema] : []),
]
---

<!doctype html>
<html lang={locale}>
  <!--x-data="{darkMode: localStorage.getItem('darkMode')}"-->
  <!--x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))"-->
  <!--x-bind:data-theme='darkMode'>-->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href={withBasePath('/favicon.svg')} />
    <link rel="alternate icon" type="image/x-icon" href={withBasePath('/favicon.ico')} />
    <meta name="generator" content={Astro.generator} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!--todo href -->

    <!-- <link rel="preload" as="image" href={src} alt="Hero" /> -->
    <SEO
      title={makeTitle}
      description={description}
      canonical={canonicalURL}
      noindex={noindex}
      languageAlternates={languageAlternates}
      openGraph={{
        basic: {
          title: makeTitle,
          type,
          image: resolvedImageWithDomain,
          url: canonicalURL,
        },
        optional: {
          description,
          locale: ogLocale,
          localeAlternate,
          siteName,
        },
        image: {
          alt: `${siteName} machining workshop`,
          width: 1200,
          height: 630,
        },
      }}
      twitter={{
        card: 'summary_large_image',
        title: makeTitle,
        description,
        image: resolvedImageWithDomain,
        imageAlt: `${siteName} machining workshop`,
      }}
    />
    <link
      rel="alternate"
      hreflang="x-default"
      href={new URL(localizedPath(defaultLocale), siteURL).toString()}
    />
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  </head>
  <body class="font-sans text-slate-900 bg-[#f7f4ef] antialiased">
    <div
      class="min-h-screen bg-[radial-gradient(1200px_600px_at_10%_-10%,rgba(186,140,90,0.2),transparent),radial-gradient(900px_420px_at_90%_10%,rgba(38,82,104,0.15),transparent),radial-gradient(1000px_520px_at_50%_120%,rgba(184,116,58,0.1),transparent)]">
      <div class="pointer-events-none fixed inset-0 -z-10 opacity-70">
        <div class="absolute -left-28 top-20 h-72 w-72 rounded-full bg-[#c58f5b]/20 blur-3xl"></div>
        <div class="absolute -right-24 top-36 h-72 w-72 rounded-full bg-[#295d70]/16 blur-3xl"></div>
        <div class="absolute left-1/2 top-[68%] h-80 w-80 -translate-x-1/2 rounded-full bg-[#b8743a]/10 blur-3xl"></div>
      </div>
      <Navbar />
      <main class="relative">
        <slot />
      </main>
      <Footer />
    </div>
  </body><script is:inline>
    // if (localStorage.getItem('darkMode') === 'dark') {
    //   document.querySelector('html').dataset.theme = 'dark'
    // }
    // if (localStorage.getItem('darkMode') === 'light') {
    //   document.querySelector('html').dataset.theme = 'light'
    // }
    // if (!localStorage.getItem('darkMode')) {
    //   let theme = window.matchMedia('(prefers-color-scheme: dark)')
    //     ? 'dark'
    //     : 'light'
    //   localStorage.setItem('darkMode', theme)
    // }
  </script>
</html>
