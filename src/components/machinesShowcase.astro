---
import { Image } from 'astro:assets'

const { machs, machines, locale } = Astro.props

const labels =
  locale === 'sk'
    ? { all: 'Všetko', cnc: 'CNC', manual: 'Klasické', saw: 'Rezanie' }
    : { all: 'All', cnc: 'CNC', manual: 'Conventional', saw: 'Cutting' }

const categorize = (name, title) => {
  const source = `${name} ${title}`.toLowerCase()
  if (source.includes('band saw') || source.includes('saw') || source.includes('píly') || source.includes('rez')) return 'saw'
  if (source.includes('cnc')) return 'cnc'
  if (source.includes('classic') || source.includes('universal') || source.includes('klas')) return 'manual'
  return 'manual'
}

const mapped = machines.map((item) => {
  const category = categorize(item.data.name, item.data.title)
  return { item, category }
})

const counts = {
  all: mapped.length,
  cnc: mapped.filter((x) => x.category === 'cnc').length,
  manual: mapped.filter((x) => x.category === 'manual').length,
  saw: mapped.filter((x) => x.category === 'saw').length,
}
---

<section class="pt-10 pb-16">
  <div class="mx-auto max-w-screen-xl px-5">
    <div class="max-w-3xl">
      <h1 class="text-4xl font-display font-semibold tracking-tight text-slate-900 lg:text-6xl">
        {machs.data.title}
      </h1>
      <p class="mt-4 text-lg text-slate-600">{machs.data.description}</p>
    </div>

    <div class="mt-8 flex flex-wrap gap-2" id="machineFilters">
      {
        [
          ['all', labels.all],
          ['cnc', labels.cnc],
          ['manual', labels.manual],
          ['saw', labels.saw],
        ].map(([key, label], idx) => (
          <button
            type="button"
            data-filter={key}
            class:list={['machine-filter', idx === 0 && 'is-active']}>
            {label} ({counts[key]})
          </button>
        ))
      }
    </div>

    <div class="mt-8 grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3">
      {
        mapped.map(({ item, category }, idx) => (
          <article
            data-category={category}
            class="machine-card"
            style={`animation-delay:${idx * 40}ms`}>
            <div class="machine-image">
              <Image
                src={item.data.avatar.src}
                alt={item.data.avatar.alt}
                fit="contain"
                loading="lazy"
                width={560}
                height={340}
              />
            </div>
            <div class="p-5">
              <h2 class="text-lg font-semibold text-slate-900">{item.data.name}</h2>
              <p class="mt-2 text-sm text-slate-600">
                {item.data.title || (locale === 'sk' ? 'Strojové vybavenie' : 'Machine equipment')}
              </p>
              <p class="mt-3 text-[11px] uppercase tracking-[0.16em] text-slate-500">
                {labels[category]}
              </p>
            </div>
          </article>
        ))
      }
    </div>
  </div>
</section>

<script>
  const buttons = Array.from(document.querySelectorAll('.machine-filter'))
  const cards = Array.from(document.querySelectorAll('.machine-card'))
  const apply = (filter) => {
    buttons.forEach((btn) => btn.classList.toggle('is-active', btn.dataset.filter === filter))
    cards.forEach((card) => {
      const visible = filter === 'all' || card.dataset.category === filter
      card.classList.toggle('is-hidden', !visible)
    })
  }
  buttons.forEach((btn) => btn.addEventListener('click', () => apply(btn.dataset.filter)))
</script>

<style>
  .machine-filter {
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.4);
    background: rgba(255, 255, 255, 0.74);
    padding: 10px 14px;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    font-weight: 700;
    color: #334155;
    transition: all 180ms ease;
  }

  .machine-filter.is-active,
  .machine-filter:hover {
    border-color: #0f172a;
    background: #0f172a;
    color: #fff;
  }

  .machine-card {
    border-radius: 16px;
    border: 1px solid rgba(148, 163, 184, 0.33);
    background: rgba(255, 255, 255, 0.84);
    box-shadow: 0 24px 44px -40px rgba(15, 23, 42, 0.56);
    overflow: hidden;
    opacity: 0;
    transform: translateY(10px);
    animation: machineIn 460ms ease forwards;
    transition: transform 220ms ease, box-shadow 220ms ease, opacity 180ms ease;
  }

  .machine-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 30px 48px -40px rgba(15, 23, 42, 0.66);
  }

  .machine-card.is-hidden {
    display: none;
    opacity: 0;
    pointer-events: none;
  }

  .machine-image {
    background: linear-gradient(180deg, rgba(248, 250, 252, 0.9), rgba(241, 245, 249, 0.8));
    border-bottom: 1px solid rgba(148, 163, 184, 0.25);
  }

  .machine-image img {
    width: 100%;
    height: 210px;
    object-fit: contain;
    padding: 14px;
  }

  @keyframes machineIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
